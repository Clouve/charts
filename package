#!/usr/bin/env bash
SCRIPT_PATH="$(
  cd "$(dirname "$0")" || exit
  pwd -P
)"
MAGNETO_PATH="$SCRIPT_PATH/../magneto"
TIMESTAMP=$(date +"%Y-%m-%d-%H-%M-%S")

for d in "$SCRIPT_PATH"/src/*/; do
  chart_name=$(basename "$d")
  helm lint "src/$chart_name"
  echo "PACKAGING src/$chart_name"
  helm package "src/$chart_name" -d repo
  helm package "src/$chart_name" -d temp-repo
  echo "-------------------------------------"
done

echo "Indexing charts"
helm repo index repo --url "/repo/"
helm repo index temp-repo --url "/repo/"

echo "Generating README.md"
echo "# Clouve Charts (Build ID: $TIMESTAMP)" > README.md
echo "" >> README.md

yq '.entries | to_entries | .[] | .value | .[] | "- [" + .name + " " + .version + "]("+ .urls[0] +")"' "$SCRIPT_PATH/repo/index.yaml" >> README.md

CHARTS=$(yq e -o=j -I=0 '.entries | to_entries | .[] | .value | .[] | .name + "," + .version + "," + .appVersion' "$SCRIPT_PATH/temp-repo/index.yaml")
rm -rf "$SCRIPT_PATH/temp-repo/"

for CHART in $CHARTS; do
  IFS=',' read -ra CHART_ARR <<< "${CHART//\"/}"
  chart_name="${CHART_ARR[0]}"
  chart_version="${CHART_ARR[1]}"
  chart_appVersion="${CHART_ARR[2]}"
  echo "PROCESSING $chart_name [version: $chart_version, appVersion: $chart_appVersion]"
  find "$MAGNETO_PATH/self-service/templates/$chart_name/.agent-config/helm" -name "*.json*" \
    -exec sed -i'.temp' -E "s/\"version\": \".+\"/\"version\": \"${chart_version}\"/g" {} +
  find "$MAGNETO_PATH/self-service/templates/$chart_name/.service-config" -name "*.json*" \
    -exec sed -i'.temp' -E "s/\"serviceVersion\": \".+\"/\"serviceVersion\": \"${chart_appVersion}\"/g" {} +
  find "$MAGNETO_PATH/self-service/templates/$chart_name" -name "*.temp" \
    -exec sh -c 'rm "$1"' _ {} \;
done
